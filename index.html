<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">

    <title>Conjunctive Normal Form</title>

    <style>
      html {
        font-family: sans-serif;
        min-height: 100%;
        position: relative;
      }

      body {
        width: 50%;
        max-width: 800px;
        min-width: 480px;
        margin: 0 auto;
      }
      
      .form input[type="number"] {
        width: 200px;
      }

      .clauseSizeResult {
        color: white;
        padding: 3px;
      }

      .result {
        color: white;
        padding: 3px;
      }

      .help {
        padding: 3px;
      }

      header {
  text-align: center;
  padding: 3px;
  background-color: DarkSalmon;
  color: white;
    left: 0;
    width: 100%;
    overflow: hidden;
}

    </style>
  </head>
  <header>
    <p>Rebecca J Young Â© 2024. This work is licensed under the <a href="http://creativecommons.org/licenses/by-sa/4.0/au/">CC BY-SA 4.0 AU</a>.</p>
  </header> 
  <body>
    <h1>Conjunctive Normal Form</h1>


<div id="clauseSize">
  <p>Write a boolean expression in Conjunctive Normal Form that is true if and only if: </p>
  <p style="text-align:center" id="mission" class="dynamic"></p>
  <ul style="list-style-type:none;" id="variables" class="dynamic"></ul>

  <label for="clauseSizeField">Number of literals per clause: </label>
  <input type="number" id="clauseSizeField" class="clauseSizeField" />
  <input type="submit" value="Submit" class="clauseSizeSubmit" /> 
  <button type="button" class="clauseSizeHelpButton">Help</button>

</div>

<br>
<div id="helpClauseSize" class="help"></div>
<p id="clauseSizeResult" class="result"></p>

<div id="firstClause"></div>
<p id="firstClauseResult" class="result"></p>

<div id="completeExpression">
</div>


<script>

const mission = document.querySelector("#mission");
const variables = document.querySelector(".variables"); 
const clauseSizeResult = document.querySelector("#clauseSizeResult");

const clauseSizeField = document.querySelector(".clauseSizeField");
const clauseSizeSubmit = document.querySelector(".clauseSizeSubmit");
const clauseSizeHelpButton = document.querySelector(".clauseSizeHelpButton");

const clauseGuess = document.querySelector(".clauseGuess");

const helpClauseSize = document.querySelector("#helpClauseSize");
const firstClause = document.querySelector("#firstClause");
const firstClauseResult = document.querySelector("#firstClauseResult");
const completeExpression = document.querySelector("#completeExpression");

const dynamic = document.querySelectorAll(".dynamic");
const results = document.querySelectorAll(".result");

//Set-up variable options----------------------------------------------------------------

const zoo = ["alpacas", "bears", "crocodiles", "dingos", 
			"elephants", "frogs", "giraffes", "hippos"]
const adopt = ["Alfonzo", "Beanie", "Cookie-Crisp", "Dynamite", 
			"Edward", "Fiercesome", "Giant", "Hayfever"]
const OS = ["Android", "Fedora", "iOS", "macOS", 
		"Raspberry Pi OS", "SUSE Linux", "Ubuntu", "Windows"]
		
const alphabet1 = ["a", "b", "c", "d", "e", "f", "g", "h"];
const alphabet2 = ["a", "f", "i", "m", "r", "s", "u", "w"];

function zooMission(qualifier, number) {
    if (number == 1) {
        return `I visited ${qualifier} 1 animal at the zoo.`;
    } else {
        return `I visited ${qualifier} ${number} animals at the zoo.`;
    }
}

function adoptionMission(qualifier, number) {
    if (number == 1) {
        return `I adopted ${qualifier} 1 cat.`;
    } else {
        return `I adopted ${qualifier} ${number} cats.`;
    }
}

function osMission(qualifier, number) {
    if (number == 1) {
        return `I am running ${qualifier} 1 operating system.`;
    } else {
        return `I am running ${qualifier} ${number} operating systems.`;
    }
}

const setup = [zoo, adopt, OS];
const alphabets = [alphabet1, alphabet1, alphabet2];
const missions = [zooMission, adoptionMission, osMission];
const variableSentence = [(x) => `I visited the ${x}`, (x) => `I adopted the cat ${x}`, (x) => `I have a computer running ${x}`];
//---------------------------------------------------------------------------------------

let resetButton;

let s; //scenario index
let setSize; //how many variables in the set
let x; //how many variables to choose at least / at most / exactly
let correctValue; //number of variables per clause
let alphabet; //list of variables 

//flags
let helpClauseSizeFlag;

clauseSizeSubmit.addEventListener("click", checkClauseSize);
clauseSizeHelpButton.addEventListener("click", createHelpClauseSize);
newGame();


function newGame() {
    s = Math.floor(Math.random() * setup.length);
    setSize = Math.floor(Math.random() * 8) + 1;
    x = Math.floor(Math.random() * setSize) + 1;
    correctValue = setSize-x+1

    alphabet = alphabets[s];
    let scenario = setup[s];

    helpClauseSizeFlag = false;
    
    mission.textContent = missions[s]('at least', x);
    
    let variableList = document.getElementById("variables");
    for (let i=0; i < setSize; i++) {
        let li = document.createElement('li');
        let text = `${alphabet[i]}: ${variableSentence[s](scenario[i])}`;
        li.innerText = text;
        variableList.appendChild(li);
	}

    clauseSizeField.value = "";
    clauseSizeField.focus();
}


function createHelpClauseSize() {
    //let help = document.getElementById("helpClauseSize"); 
    let help = helpClauseSize;

    if (helpClauseSizeFlag) {
        helpClauseSizeFlag = false;
        help.style.backgroundColor = "white";
        empty(help);
        return;
    }

    helpClauseSizeFlag = true;
    help.style.backgroundColor ="palegreen";

    function helpParagraph(texty) {
        let par = document.createElement("p");
        par.textContent = texty;
        return par;
    }

    help.appendChild(helpParagraph("We need to make our clauses just small enough that the perfect number of variables are missing."));
    help.appendChild(helpParagraph("Let N be the number of variables in the set:"));

    function exampleListPoint(x, n, xQualifier, size) {
        `At least 1: ${buildExpression(1, setSize)} <-- there are N literals per clause`;

        let li = document.createElement("li");
        
        let qualifier = document.createTextNode(`At least ${xQualifier}: `)
        let exampleExpression = document.createElement("span");
        exampleExpression.appendChild(document.createTextNode(buildExpression(x, n)));
        exampleExpression.style.backgroundColor = "cornsilk";

        let explanation;
        if (size==1) {
            explanation = document.createTextNode(` <-- there is 1 literal per clause`);
        } else {
            explanation = document.createTextNode(` <-- there are ${size} literals per clause`);
        }
        
        li.appendChild(qualifier);
        li.appendChild(exampleExpression);
        li.appendChild(explanation);
        return li
    }

    function buildExpression(x, n) {
        let expression; 

        if (x==1) {
            return `(${alphabet.slice(0,n).join(" OR ")})`;
        } else if (x==n) {
            return `(${alphabet.slice(0,n).join(") AND (")})`;
        } else {
            let size = n-x+1;
            return `(${alphabet.slice(0, size).join(" OR ")}) AND ... AND (${alphabet.slice(n-size, n).join(" OR ")})`;
        }
    }

    let exampleList = document.createElement("ul");
    exampleList.appendChild(exampleListPoint(1, setSize, 1, "N"));
    if (setSize > 2) {
        exampleList.appendChild(exampleListPoint(2, setSize, 2, "N-1"));
    }
    if (setSize > 3) {
        exampleList.appendChild(document.createElement("li").appendChild(document.createTextNode("...")));
        exampleList.appendChild(exampleListPoint((setSize-1), setSize, "N-1", 2));
    }
    if (setSize > 1) {
        exampleList.appendChild(exampleListPoint(setSize, setSize, "N", 1));
    }
    
    help.appendChild(exampleList);
    help.appendChild(helpParagraph("Can you see the pattern?"));
}

function checkClauseSize() {
  const userGuess = Number(clauseSizeField.value);
  if (userGuess == correctValue) {
    //turn Help off
    if (helpClauseSizeFlag) {createHelpClauseSize();}
    //create correct banner
  	clauseSizeResult.textContent = "Correct";
  	clauseSizeResult.style.backgroundColor = "green";
  	createFirstClause();
  } else {
  	clauseSizeResult.textContent = "Incorrect";
  	clauseSizeResult.style.backgroundColor = "red";
    guessField.value = "";
    guessField.focus();
  }
}


function createFirstClause() {
    let firstClauseInstructions = document.createElement("p");
    firstClauseInstructions.textContent = "Write the literals for the first clause as you would if writing clauses in lexicographical order:";

    firstClause.appendChild(firstClauseInstructions);
    firstClause.appendChild(document.createTextNode("("));

    var literal = document.createElement("input");
    literal.setAttribute("type", "text");
    literal.setAttribute("id", "literal_0");
    literal.setAttribute("style", "width: 30px");
    literal.setAttribute("placeholder", "");
    firstClause.appendChild(literal);

    for (let i=1; i < correctValue; i++) {
        firstClause.appendChild(document.createTextNode(" OR "));
        var literal = document.createElement("input");
        literal.setAttribute("type", "text");
        literal.setAttribute("id", `literal_${i}`);
        literal.setAttribute("style", "width: 30px");
        literal.setAttribute("placeholder", "");
        firstClause.appendChild(literal);
    }
    firstClause.appendChild(document.createTextNode(")    "));

    // create a submit button
    var s = document.createElement("input");
    s.setAttribute("type", "submit");
    s.setAttribute("class", "firstClauseSubmit");
    s.setAttribute("value", "Submit");
    firstClause.appendChild(s); 

    const firstClauseSubmit = document.querySelector(".firstClauseSubmit");
    firstClauseSubmit.addEventListener("click", checkFirstClause);
}


function checkFirstClause() {    
    let userGuess = [];
    for (let i=0; i< correctValue; i++) {
        var x = String(document.getElementById(`literal_${i}`).value);
        userGuess.push(x.toLowerCase());
    }
    let flag = true;
    for (let i=0; i < correctValue; i++) {
        if (userGuess[i] != alphabet[i]) {
        flag = false;
        }
    }
    if (flag) {
        firstClauseResult.textContent = "Correct";
        firstClauseResult.style.backgroundColor = "green";
        buildExpression();
    } else {
        firstClauseResult.textContent = "Incorrect";
        firstClauseResult.style.backgroundColor = "red";
    }
}


function buildExpression() {

    function build_clauses(n, excluded, sub_exp) {
        if (n==1) {
            //sub_exp.append( [v for v in var_i if v not in excluded] )
            let temp = [];
            for (let i=0; i<setSize; i++) {
                if (!(excluded.includes(i))){
                    temp.push(i);
                }
            }
            sub_exp.push(temp);
        } else {
                var x = excluded[excluded.length-1];
                for (let i=(x+1); i < setSize; i++) { 
                    build_clauses(n-1, excluded.concat([i]), sub_exp)
            } 
        }
    }

    let clauses = []
    build_clauses(x, [-1], clauses);
    clauses.reverse();

    let displayClauses = [];
    for (const clause of clauses) {
        const alphabetClause = clause.map((lit) => alphabet[lit]);
        displayClauses.push(alphabetClause.join(" OR "));
    }
    let expression = "(".concat(displayClauses.join(") AND ("), ")");
    completeExpression.textContent = expression;

    setGameOver();
}


function setGameOver() {
  resetButton = document.createElement("button");
  resetButton.textContent = "New puzzle";
  document.body.append(resetButton);
  resetButton.addEventListener("click", resetGame);
  //lock other buttons
}


function empty(parent) {
        while (parent.lastChild) {
            parent.removeChild(parent.lastChild);
        }
}

function resetGame() {
    empty(completeExpression);
    empty(firstClause);
    empty(helpClauseSize);
    helpClauseSize.style.backgroundColor = "white";

    for (dyn of dynamic) {
        empty(dyn);
        dyn.textContent = "";
    }
    for (result of results) {
        result.style.backgroundColor = "white";
        result.textContent = "";
    }
  
    resetButton.parentNode.removeChild(resetButton);

    newGame();
}
</script>


  </body>
</html>
